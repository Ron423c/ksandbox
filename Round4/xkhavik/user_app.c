/*
 * user_app.c
 *
 *  Created on: 19.02.2017
 *      Author: Viktor Khabalevskyi
 */
#include <linux/fb.h>
#include <stdio.h>
#include <stdint.h>
#include <stdlib.h>
#include <fcntl.h>
#include <sys/mman.h>
#include <sys/ioctl.h>
#include <sys/stat.h>
#include <errno.h>
#include <string.h>
#include <pthread.h>
#include <sys/select.h>
#include <signal.h>
#include <time.h>

/*static uint8_t reverse_bits(uint8_t b)
{
	return ((b * 0x0802LU & 0x22110LU) | (b * 0x8020LU & 0x88440LU)) * 0x10101LU >> 16;
}*/

/* -------------- font description -------------- */
typedef struct {
	uint8_t FontWidth;     /*!< Font width in pixels */
	uint8_t FontHeight;    /*!< Font height in pixels */
        const uint16_t *data;  /*!< Pointer to data font data array */
} TM_FontDef_t;

const uint16_t TM_Font7x10[] = {
0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, // sp
0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0x0000, 0x1000, 0x0000, 0x0000, // !
0x2800, 0x2800, 0x2800, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, // "
0x2400, 0x2400, 0x7C00, 0x2400, 0x4800, 0x7C00, 0x4800, 0x4800, 0x0000, 0x0000, // #
0x3800, 0x5400, 0x5000, 0x3800, 0x1400, 0x5400, 0x5400, 0x3800, 0x1000, 0x0000, // $
0x2000, 0x5400, 0x5800, 0x3000, 0x2800, 0x5400, 0x1400, 0x0800, 0x0000, 0x0000, // %
0x1000, 0x2800, 0x2800, 0x1000, 0x3400, 0x4800, 0x4800, 0x3400, 0x0000, 0x0000, // &
0x1000, 0x1000, 0x1000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, // '
0x0800, 0x1000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x1000, 0x0800, // (
0x2000, 0x1000, 0x0800, 0x0800, 0x0800, 0x0800, 0x0800, 0x0800, 0x1000, 0x2000, // )
0x1000, 0x3800, 0x1000, 0x2800, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, // *
0x0000, 0x0000, 0x1000, 0x1000, 0x7C00, 0x1000, 0x1000, 0x0000, 0x0000, 0x0000, // +
0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x1000, 0x1000, 0x1000, // ,
0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x3800, 0x0000, 0x0000, 0x0000, 0x0000, // -
0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x1000, 0x0000, 0x0000, // .
0x0800, 0x0800, 0x1000, 0x1000, 0x1000, 0x1000, 0x2000, 0x2000, 0x0000, 0x0000, // /
0x3800, 0x4400, 0x4400, 0x5400, 0x4400, 0x4400, 0x4400, 0x3800, 0x0000, 0x0000, // 0
0x1000, 0x3000, 0x5000, 0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0x0000, 0x0000, // 1
0x3800, 0x4400, 0x4400, 0x0400, 0x0800, 0x1000, 0x2000, 0x7C00, 0x0000, 0x0000, // 2
0x3800, 0x4400, 0x0400, 0x1800, 0x0400, 0x0400, 0x4400, 0x3800, 0x0000, 0x0000, // 3
0x0800, 0x1800, 0x2800, 0x2800, 0x4800, 0x7C00, 0x0800, 0x0800, 0x0000, 0x0000, // 4
0x7C00, 0x4000, 0x4000, 0x7800, 0x0400, 0x0400, 0x4400, 0x3800, 0x0000, 0x0000, // 5
0x3800, 0x4400, 0x4000, 0x7800, 0x4400, 0x4400, 0x4400, 0x3800, 0x0000, 0x0000, // 6
0x7C00, 0x0400, 0x0800, 0x1000, 0x1000, 0x2000, 0x2000, 0x2000, 0x0000, 0x0000, // 7
0x3800, 0x4400, 0x4400, 0x3800, 0x4400, 0x4400, 0x4400, 0x3800, 0x0000, 0x0000, // 8
0x3800, 0x4400, 0x4400, 0x4400, 0x3C00, 0x0400, 0x4400, 0x3800, 0x0000, 0x0000, // 9
0x0000, 0x0000, 0x1000, 0x0000, 0x0000, 0x0000, 0x0000, 0x1000, 0x0000, 0x0000, // :
0x0000, 0x0000, 0x0000, 0x1000, 0x0000, 0x0000, 0x0000, 0x1000, 0x1000, 0x1000, // ;
0x0000, 0x0000, 0x0C00, 0x3000, 0x4000, 0x3000, 0x0C00, 0x0000, 0x0000, 0x0000, // <
0x0000, 0x0000, 0x0000, 0x7C00, 0x0000, 0x7C00, 0x0000, 0x0000, 0x0000, 0x0000, // =
0x0000, 0x0000, 0x6000, 0x1800, 0x0400, 0x1800, 0x6000, 0x0000, 0x0000, 0x0000, // >
0x3800, 0x4400, 0x0400, 0x0800, 0x1000, 0x1000, 0x0000, 0x1000, 0x0000, 0x0000, // ?
0x3800, 0x4400, 0x4C00, 0x5400, 0x5C00, 0x4000, 0x4000, 0x3800, 0x0000, 0x0000, // @
0x1000, 0x2800, 0x2800, 0x2800, 0x2800, 0x7C00, 0x4400, 0x4400, 0x0000, 0x0000, // A
0x7800, 0x4400, 0x4400, 0x7800, 0x4400, 0x4400, 0x4400, 0x7800, 0x0000, 0x0000, // B
0x3800, 0x4400, 0x4000, 0x4000, 0x4000, 0x4000, 0x4400, 0x3800, 0x0000, 0x0000, // C
0x7000, 0x4800, 0x4400, 0x4400, 0x4400, 0x4400, 0x4800, 0x7000, 0x0000, 0x0000, // D
0x7C00, 0x4000, 0x4000, 0x7C00, 0x4000, 0x4000, 0x4000, 0x7C00, 0x0000, 0x0000, // E
0x7C00, 0x4000, 0x4000, 0x7800, 0x4000, 0x4000, 0x4000, 0x4000, 0x0000, 0x0000, // F
0x3800, 0x4400, 0x4000, 0x4000, 0x5C00, 0x4400, 0x4400, 0x3800, 0x0000, 0x0000, // G
0x4400, 0x4400, 0x4400, 0x7C00, 0x4400, 0x4400, 0x4400, 0x4400, 0x0000, 0x0000, // H
0x3800, 0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0x3800, 0x0000, 0x0000, // I
0x0400, 0x0400, 0x0400, 0x0400, 0x0400, 0x0400, 0x4400, 0x3800, 0x0000, 0x0000, // J
0x4400, 0x4800, 0x5000, 0x6000, 0x5000, 0x4800, 0x4800, 0x4400, 0x0000, 0x0000, // K
0x4000, 0x4000, 0x4000, 0x4000, 0x4000, 0x4000, 0x4000, 0x7C00, 0x0000, 0x0000, // L
0x4400, 0x6C00, 0x6C00, 0x5400, 0x4400, 0x4400, 0x4400, 0x4400, 0x0000, 0x0000, // M
0x4400, 0x6400, 0x6400, 0x5400, 0x5400, 0x4C00, 0x4C00, 0x4400, 0x0000, 0x0000, // N
0x3800, 0x4400, 0x4400, 0x4400, 0x4400, 0x4400, 0x4400, 0x3800, 0x0000, 0x0000, // O
0x7800, 0x4400, 0x4400, 0x4400, 0x7800, 0x4000, 0x4000, 0x4000, 0x0000, 0x0000, // P
0x3800, 0x4400, 0x4400, 0x4400, 0x4400, 0x4400, 0x5400, 0x3800, 0x0400, 0x0000, // Q
0x7800, 0x4400, 0x4400, 0x4400, 0x7800, 0x4800, 0x4800, 0x4400, 0x0000, 0x0000, // R
0x3800, 0x4400, 0x4000, 0x3000, 0x0800, 0x0400, 0x4400, 0x3800, 0x0000, 0x0000, // S
0x7C00, 0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0x0000, 0x0000, // T
0x4400, 0x4400, 0x4400, 0x4400, 0x4400, 0x4400, 0x4400, 0x3800, 0x0000, 0x0000, // U
0x4400, 0x4400, 0x4400, 0x2800, 0x2800, 0x2800, 0x1000, 0x1000, 0x0000, 0x0000, // V
0x4400, 0x4400, 0x5400, 0x5400, 0x5400, 0x6C00, 0x2800, 0x2800, 0x0000, 0x0000, // W
0x4400, 0x2800, 0x2800, 0x1000, 0x1000, 0x2800, 0x2800, 0x4400, 0x0000, 0x0000, // X
0x4400, 0x4400, 0x2800, 0x2800, 0x1000, 0x1000, 0x1000, 0x1000, 0x0000, 0x0000, // Y
0x7C00, 0x0400, 0x0800, 0x1000, 0x1000, 0x2000, 0x4000, 0x7C00, 0x0000, 0x0000, // Z
0x1800, 0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0x1800, // [
0x2000, 0x2000, 0x1000, 0x1000, 0x1000, 0x1000, 0x0800, 0x0800, 0x0000, 0x0000, /* \ */
0x3000, 0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0x3000, // ]
0x1000, 0x2800, 0x2800, 0x4400, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, // ^
0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xFE00, // _
0x2000, 0x1000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, // `
0x0000, 0x0000, 0x3800, 0x4400, 0x3C00, 0x4400, 0x4C00, 0x3400, 0x0000, 0x0000, // a
0x4000, 0x4000, 0x5800, 0x6400, 0x4400, 0x4400, 0x6400, 0x5800, 0x0000, 0x0000, // b
0x0000, 0x0000, 0x3800, 0x4400, 0x4000, 0x4000, 0x4400, 0x3800, 0x0000, 0x0000, // c
0x0400, 0x0400, 0x3400, 0x4C00, 0x4400, 0x4400, 0x4C00, 0x3400, 0x0000, 0x0000, // d
0x0000, 0x0000, 0x3800, 0x4400, 0x7C00, 0x4000, 0x4400, 0x3800, 0x0000, 0x0000, // e
0x0C00, 0x1000, 0x7C00, 0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0x0000, 0x0000, // f
0x0000, 0x0000, 0x3400, 0x4C00, 0x4400, 0x4400, 0x4C00, 0x3400, 0x0400, 0x7800, // g
0x4000, 0x4000, 0x5800, 0x6400, 0x4400, 0x4400, 0x4400, 0x4400, 0x0000, 0x0000, // h
0x1000, 0x0000, 0x7000, 0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0x0000, 0x0000, // i
0x1000, 0x0000, 0x7000, 0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0xE000, // j
0x4000, 0x4000, 0x4800, 0x5000, 0x6000, 0x5000, 0x4800, 0x4400, 0x0000, 0x0000, // k
0x7000, 0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0x0000, 0x0000, // l
0x0000, 0x0000, 0x7800, 0x5400, 0x5400, 0x5400, 0x5400, 0x5400, 0x0000, 0x0000, // m
0x0000, 0x0000, 0x5800, 0x6400, 0x4400, 0x4400, 0x4400, 0x4400, 0x0000, 0x0000, // n
0x0000, 0x0000, 0x3800, 0x4400, 0x4400, 0x4400, 0x4400, 0x3800, 0x0000, 0x0000, // o
0x0000, 0x0000, 0x5800, 0x6400, 0x4400, 0x4400, 0x6400, 0x5800, 0x4000, 0x4000, // p
0x0000, 0x0000, 0x3400, 0x4C00, 0x4400, 0x4400, 0x4C00, 0x3400, 0x0400, 0x0400, // q
0x0000, 0x0000, 0x5800, 0x6400, 0x4000, 0x4000, 0x4000, 0x4000, 0x0000, 0x0000, // r
0x0000, 0x0000, 0x3800, 0x4400, 0x3000, 0x0800, 0x4400, 0x3800, 0x0000, 0x0000, // s
0x2000, 0x2000, 0x7800, 0x2000, 0x2000, 0x2000, 0x2000, 0x1800, 0x0000, 0x0000, // t
0x0000, 0x0000, 0x4400, 0x4400, 0x4400, 0x4400, 0x4C00, 0x3400, 0x0000, 0x0000, // u
0x0000, 0x0000, 0x4400, 0x4400, 0x2800, 0x2800, 0x2800, 0x1000, 0x0000, 0x0000, // v
0x0000, 0x0000, 0x5400, 0x5400, 0x5400, 0x6C00, 0x2800, 0x2800, 0x0000, 0x0000, // w
0x0000, 0x0000, 0x4400, 0x2800, 0x1000, 0x1000, 0x2800, 0x4400, 0x0000, 0x0000, // x
0x0000, 0x0000, 0x4400, 0x4400, 0x2800, 0x2800, 0x1000, 0x1000, 0x1000, 0x6000, // y
0x0000, 0x0000, 0x7C00, 0x0800, 0x1000, 0x2000, 0x4000, 0x7C00, 0x0000, 0x0000, // z
0x1800, 0x1000, 0x1000, 0x1000, 0x2000, 0x2000, 0x1000, 0x1000, 0x1000, 0x1800, // {
0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0x1000, // |
0x3000, 0x1000, 0x1000, 0x1000, 0x0800, 0x0800, 0x1000, 0x1000, 0x1000, 0x3000, // }
0x0000, 0x0000, 0x0000, 0x7400, 0x4C00, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, // ~
};

TM_FontDef_t TM_Font_7x10 = {
    7,
    10,
    TM_Font7x10
};
typedef struct {
	int x_raw;
	int y_raw;
	int z_raw;
	int curX;
	int curY;
	timer_t timerid;
	uint8_t *fbp;
	uint8_t flag_read;
}accel_data_t, *pAccelData_t;

accel_data_t accel_data = {
	0,
	0,
	0,
	0,
	0,
	0,
	NULL,
	0
};

pAccelData_t pAccelData = &accel_data;

TM_FontDef_t* Font = &TM_Font_7x10;
#define DATA_PATH "/sys/bus/iio/devices/iio:device0"
#define CLOCKID CLOCK_REALTIME
#define SIG SIGRTMIN

void draw_pixel(uint8_t *fb, int x, int y, int val)
{
	int lineal_bit = y * 128 + x;
	int lineal_byte = lineal_bit / 8;
	int bit_pos = lineal_bit - lineal_byte * 8;

	if (val)
		fb[lineal_byte] |= (1 << bit_pos);
	else
		fb[lineal_byte] &= ~(1 << bit_pos);
}

static char put_c(uint8_t *fb, TM_FontDef_t* font, char ch, int x, int y)
{
	int i, j, val;
	for (i = 0; i < Font->FontHeight; i++) {
	   val = Font->data[(ch - 32) * Font->FontHeight + i];
	   for (j = 0; j < Font->FontWidth; j++) {
		   if ((val << j) & 0x8000) {
			   draw_pixel(fb, x + j, y + i, 1);
		   } else {
			   draw_pixel(fb, x + j, y + i, 0);
		   }
	   }
	}
	return ch;
}

static char put_s( uint8_t* fb, TM_FontDef_t* font, char* str, int x, int y)
{
	while (*str) {
                        put_c(fb, font, *str, x, y);
			x += Font->FontWidth;
			str++;
        }
	return *str; /* Everything is OK, zero should be returned */
}


static void read_accel()
{
	char accel[20];
	int val;
	FILE *f;
	f = fopen(DATA_PATH"/in_accel_x_raw", "r");
	fscanf(f, "%d", &val);
	fclose(f);
	snprintf(accel, 15, "ACC X=%d", val);
	put_s(pAccelData->fbp, Font, accel, pAccelData->curX, pAccelData->curY);
	pAccelData->curY += Font->FontHeight;

	f = fopen(DATA_PATH"/in_accel_y_raw", "r");
	fscanf(f, "%d", &val);
	fclose(f);
	snprintf(accel, 15, "ACC Y=%d", val);
	put_s(pAccelData->fbp, Font, accel, pAccelData->curX, pAccelData->curY);
	pAccelData->curY += Font->FontHeight;

	f = fopen(DATA_PATH"/in_accel_z_raw", "r");
	fscanf(f, "%d", &val);
	fclose(f);
	snprintf(accel, 15, "ACC Z=%d", val);
	put_s(pAccelData->fbp, Font, accel, pAccelData->curX, pAccelData->curY);
}

static void read_temperature()
{
	char temp[20];
	int val;
	FILE *f;
	f = fopen(DATA_PATH"/in_temp_raw", "r");
	fscanf(f, "%d", &val);
	fclose(f);
	snprintf(temp, 15, "TEMP =%d", val);
	put_s(pAccelData->fbp, Font, temp, pAccelData->curX, pAccelData->curY);
}
static void display_wake_up()
{
	FILE *f = fopen("/sys/class/graphics/fb0/blank", "w");
	if (!f) {
		printf("open error blank\n");
		return;
	}

	fputs("0", f);
	fclose(f);
	f = fopen("/sys/class/vtconsole/vtcon1/bind", "w");
	if (!f) {
		printf("open error bind\n");
		return;
	}
	fputs("0", f);
	fclose(f);
}

static void accel_read(int sig, siginfo_t *si, void *uc)
{
	pAccelData->flag_read = 1;
}

static int init_timer(void)
{
	timer_t tid;
	struct sigevent sigev;
	struct sigaction sa;
	sigset_t mask;
	struct itimerspec ival;

	/* No blocking signals */
	sigemptyset(&mask);
	sigprocmask(SIG_SETMASK, &mask, NULL);

	/* Registring for SIGRMIN */
	sa.sa_flags = SA_SIGINFO;
	sigemptyset(&sa.sa_mask);
	sa.sa_sigaction = accel_read;
	if (sigaction(SIGRTMIN, &sa, NULL) == -1) {
	  perror("sigaction failed\n");
	  return -1;
	}
	/* Signal after finish */
	sigev.sigev_notify = SIGEV_SIGNAL;
	sigev.sigev_signo = SIGRTMIN;
	sigev.sigev_value.sival_int = 1;

	if (timer_create(CLOCK_MONOTONIC, &sigev, &tid) == -1) {
	  perror("timer create error");
	  return -1;
	}

	pAccelData->timerid = tid;

	ival.it_value.tv_sec = 1;
	ival.it_value.tv_nsec = 0;
	ival.it_interval.tv_sec = 1;
	ival.it_interval.tv_nsec = 0;
	if (timer_settime(tid, 0, &ival, NULL) == -1) {
	  perror("timer settime error");
	  return -1;
	}
}

int main(int argc, char *argv[])
{
	char *fb_name;
	int fb_fd;
	struct fb_var_screeninfo vinfo;
	long screensize;
	uint8_t *fbp;
	int accel_x;
	FILE *f;
	int ret;

	/* Check parameters */
	if (argc != 2) {
		printf("Usage: framebuffer_device\n");
		return EINVAL;
	}
	fb_name = argv[1];
	/* Open framebuffer */
	fb_fd = open(fb_name, O_RDWR);
	if (fb_fd < 0) {
		printf("Could not oped framebuffer device %s !\n", fb_name);
		return EIO;
	}
	/* Wake up display */
	display_wake_up();

	/* Get variable screen information */
	ioctl(fb_fd, FBIOGET_VSCREENINFO, &vinfo);
	/* Print some parameters */
	printf("vinfo.bits_per_pixel = %d\n", vinfo.bits_per_pixel);
	printf("vinfo.yres_virtual = %d\n", vinfo.yres_virtual);
	printf("vinfo.xres_virtual = %d\n", vinfo.xres_virtual);
	/* Caluculate screen size */
	screensize = vinfo.yres_virtual * vinfo.xres_virtual * vinfo.bits_per_pixel / 8;
	printf("screensize = %ld\n", screensize);
	/* Map frame buffer */
	pAccelData->fbp = mmap(0, screensize, PROT_READ | PROT_WRITE, MAP_SHARED, fb_fd, (off_t)0);
	if(pAccelData->fbp == NULL) {
		perror("Mapping frame buffer error");
		return -1;
	}

        memset(pAccelData->fbp, 0, screensize);
        init_timer();
        while (1) {
		int c = getchar();
		if(pAccelData->flag_read) {
			read_accel();
			pAccelData->curY += Font->FontHeight;
			read_temperature();
			pAccelData->curY = 0;
			pAccelData->flag_read = 0;
		}
		if (c == 'e')
			break;
        }

        printf("Finish\n");
        timer_delete(pAccelData->timerid);
    /* Close fbdev */
        munmap(fbp, screensize);
        close(fb_fd);

        return 0;
}
